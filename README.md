# kmailerExcel2json

## 概要
このスクリプトは、Excelファイル内の特定のマーカーに基づいてデータを抽出し、JSON形式およびYAML形式に変換するツールです。複数行にまたがるヘッダー情報およびデータ行をパースし、ネストされた辞書構造に変換するほか、元のシートを複製して変換結果を追記した新規Excelファイルとして保存します。

最新のアップデートでは、起動時の引数が拡張され、以下の機能が追加・改善されています:
- **ヘルプオプション**: `-h` または `--help` を指定することで、使用方法のヘルプメッセージを表示します。
- **ファイル差し替え**: `-r` または `--replace` オプションを指定すると、処理後に生成された出力ファイルで入力ファイルを自動的に置き換えます。
- **出力ファイルの自動生成**: 出力ファイル名を省略した場合、入力ファイル名にタイムスタンプを付加した名前が自動生成されます。

## 仕様

### 主な機能
- **マーカーによる行の指定**  
  - ヘッダー行は、A列に `#JSON_START` が記載された行を対象とします。  
  - データ行は、A列に `#JSON_DATA`（自動補完されたマーカー）が記載された行を対象とします。  
  - データブロックは `#JSON_DATA_START` から `#JSON_DATA_END` の範囲で囲まれ、原則としてすべての行がデータ行として処理されます（ただし、セルの値が `#NOT` の場合は変換対象から除外されます）。

- **ヘッダーの階層構造によるデータ変換**  
  ヘッダーが複数行にわたる場合、上側の行を上位階層、下側の行を下位階層として解釈し、各データ行はヘッダー情報に基づいたネストされた辞書形式に変換されます。  

  **例:**  

  | A列         | B列         | C列         | D列         |
  |-------------|-------------|-------------|-------------|
  | #JSON_START | #mailset    | #mailset    | #templates  |
  | #JSON_START | #title      | #body       | #name       |
  | #JSON_DATA  | toFamily    | Thanks...   | Morning     |
  
  変換結果（一件分）の例:
  ```json
  {
    "mailset": {
      "title": "toFamily",
      "body": "Thanks..."
    },
    "templates": {
      "name": "Morning"
    }
  }
  ```

- **Excelシートの複製と出力**  
  指定されたExcelファイル内の対象シート（シート名が `JSON_START` のシート、またはシートが1つの場合のそのシート）を複製し、複製シートの名称を `JSON_YYYYMMDD_HHMMSS`（例：`JSON_20250202_123456`）に変更します。  
  変換後のJSONおよびYAMLデータは、複製シートの最終行から10行下に出力され、各セルはテキスト形式かつ折り返し表示に設定されます。

## 使用方法

### 依存パッケージ
- Python 3.x
- [openpyxl](https://pypi.org/project/openpyxl/)
- [PyYAML](https://pypi.org/project/PyYAML/)

以下のコマンドで必要なパッケージをインストールしてください:
```bash
pip install openpyxl PyYAML
```

### 実行方法
ターミナル（またはコマンドプロンプト）で以下のように実行します:
```bash
python kmailerExcel2json.py 入力ファイル.xlsx [出力ファイル.xlsx] [-r|--replace] [-h|--help]
```

#### パラメータの意味
- **入力ファイル.xlsx**  
  処理対象のExcelファイルのパス（必須）。
  
- **出力ファイル.xlsx**  
  変換結果を含む新しいExcelファイルとして出力されるパス（任意）。  
  ※省略した場合、入力ファイル名にタイムスタンプを付加した名前が自動生成されます。
  
- **-r または --replace**  
  このオプションを指定すると、処理後に生成された出力ファイルで入力ファイルを置き換えます。
  
- **-h または --help**  
  ヘルプメッセージを表示し、使用方法を確認できます。

### シートの選択ルール
- Excelファイル内に「JSON_START」という名前のシートが存在する場合、そのシートが処理対象として自動的に選択されます。
- シートが1つのみの場合、そのシートが対象となります。
- 複数シートがある場合で、「JSON_START」という名前のシートが見つからないとエラーとなります。

## 更新履歴
- **最新アップデート**:  
  - コマンドライン引数に `-h`/`--help` オプションを追加し、ヘルプ表示機能を実装。  
  - `-r`/`--replace` オプションを導入し、処理後に出力ファイルで入力ファイルを置き換える機能を追加。  
  - 出力ファイル名の自動生成およびエラーメッセージの改善を実施。  
- 初版: 作成日を記入してください

## ライセンス
MITライセンスです。

## Copyright
Copyright (c) 2020 koga2020a

