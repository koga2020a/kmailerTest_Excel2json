# kmailerExcel2json

## 概要
このスクリプトは、Excelファイル内に記載された特定のマーカーに基づいてデータを抽出し、JSON形式およびYAML形式に変換するツールです。指定されたExcelシートから複数行のヘッダー情報やデータ行をパースし、ネストされた辞書形式に変換します。加えて、元のシートを複製し、変換結果を追記して新たなExcelファイルとして保存する仕組みとなっています。

## 仕様

### 主な機能
- **マーカーによる行の指定**  
  - ヘッダー行は先頭セルに `#JSON_START` が記載されている行が対象です。
  - データ行は先頭セルに `#JSON_DATA`（内部的に補完されたマーカー）が記載されている行を対象とします。
  - データブロックの開始および終了は `#JSON_DATA_START` と `#JSON_DATA_END` により示され、これらは自動的に `#JSON_DATA` に変換されます。
  - セルの値が `#NOT` の場合は、変換対象から除外されます。

- **ヘッダーの階層構造によるデータ変換**  
  複数行存在するヘッダー情報は、上側の行が上位階層、下側の行が下位階層として解釈されます。各データ行は、ヘッダーで定義されたキー階層に基づいてネストされた辞書形式に変換されます。

- **Excelシートの複製と出力**  
  入力ファイル内の対象シート（シート名が `JSON_START` のシート、またはシートが1つの場合のそのシート）を複製し、複製シートの名前を `JSON_YYYYMMDD_HHMMSS`（例：JSON_20250202_123456）に変更します。  
  変換後のJSONおよびYAMLデータは、複製シートの最終行から10行下の行に出力され、各セルはテキスト形式かつ折り返し表示に設定されます。

### Excelファイルの仕様

#### ヘッダー行
- **対象行**  
  A列に `#JSON_START` が記載されている行がヘッダー行です。

- **階層構造**  
  ヘッダーは複数行にわたる場合があり、上位階層から下位階層へとキーがネストされます。  
  **例:**  
  | A列         | B列         | C列         | D列          |
  |-------------|-------------|-------------|--------------|
  | #JSON_START | #mailset    | #mailset   | #templates   |
  | #JSON_START | #title      | #body      | #name        |

  ※ ヘッダーセルの先頭に付く `#` はキー名としては省略され、実際のキーは `mailset`、`title`、`body`、`templates`、`name` となります。

#### データ行
- **対象行**  
  A列に `#JSON_DATA` が記載されている行がデータ行です。  
  ※ `transform_data_markers` 関数により、`#JSON_DATA_START` ～ `#JSON_DATA_END` ブロック内の行は自動的に `#JSON_DATA` に置換されます。

- **データの展開**  
  ヘッダー情報に基づき、各データ行は下記のようなネストされた辞書に変換されます。  
  **例:**  
  | A列         | B列        | C列               | D列      |
  |-------------|------------|-------------------|----------|
  | #JSON_START | #mailset   | #mailset          | #templates |
  | #JSON_START | #title     | #body             | #name    |
  | #JSON_DATA  | toFamily   | ThanksFamilyTest  | Morning  |
  | #JSON_DATA  | toFamily   | ThanksFamilyTest  | Evening  |
  | #JSON_DATA  | toFamily   | ThanksFamilyTest  | Night    |

  上記は以下のように変換されます（例として1件分）:
  ```json
  {
    "mailset": {
      "title": "toFamily",
      "body": "ThanksFamilyTest"
    },
    "templates": {
      "name": "Morning"
    }
  }
  ```

#### マーカーの解釈
- **`#JSON_DATA_START` と `#JSON_DATA_END`**  
  これらのマーカーで囲まれた範囲の行は、基本的にすべて `#JSON_DATA` として扱われ、データ行に含まれます（ただし、セルの値が `#NOT` の場合はそのまま残され、変換対象から除外されます）。

## 使用方法

### 依存パッケージ
以下のパッケージが必要です。

- Python 3.x
- [openpyxl](https://pypi.org/project/openpyxl/)
- [PyYAML](https://pypi.org/project/PyYAML/)

インストールは以下のコマンドで行ってください。

```bash
pip install openpyxl PyYAML
```

### 実行方法
ターミナル（コマンドプロンプト）で以下のように実行します。

```bash
python kmailerExcel2json.py 入力ファイル.xlsx 出力ファイル.xlsx
```


#### パラメータの意味
- **入力ファイル.xlsx**  
  処理対象のExcelファイルのパスです。

- **出力ファイル.xlsx**  
  変換結果を含む新しいExcelファイルとして出力されるパスです。

### シートの選択ルール
- Excelファイル内に「JSON_START」という名前のシートが存在する場合、そのシートが処理対象として自動的に選択されます。
- シートが1つのみの場合は、そのシートが対象となります。
- 複数シートある場合で、「JSON_START」という名前のシートが見つからないとエラーとなります。

## 注意点
- Excelシート内のデータ構成は、上記の仕様に準拠していることが前提です。仕様に沿っていない場合、意図しない結果になる恐れがあります。
- データ型（数値、日付など）の変換処理は最小限に留められており、必要に応じて追加の処理を実装する必要があります。
- シートの複製および変換結果の出力位置は、複製シートの最終行から10行下に固定されています。ご利用のExcelファイルによっては調整が必要な場合があります。

## ライセンス
このスクリプトは自由に利用・改変いただけます。必要に応じて著作権表示やライセンス文を追加してください。

## 更新履歴
- 初版: 作成日を記入してください
